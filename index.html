<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EVIDENCIA ¬∑ Biblioteca de Recursos</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f2ed;
  --surface: #ffffff;
  --surface2: #ece8e1;
  --border: #d6cfc4;
  --text: #1a1612;
  --muted: #7a6f63;
  --accent: #c0392b;
  --sidebar: #1a1612;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'DM Mono', monospace;
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  overflow: hidden;
}

.app { display:flex; height:100vh; }

/* SIDEBAR */
.sidebar {
  width:300px; min-width:300px;
  background: var(--sidebar);
  display:flex; flex-direction:column;
  overflow:hidden;
}
.sidebar-header {
  padding:1.5rem 1.2rem 1rem;
  border-bottom:1px solid #2a2520;
  flex-shrink:0;
}
.logo {
  font-family:'Syne',sans-serif;
  font-weight:800; font-size:1.3rem;
  color:#f5f2ed;
  display:flex; align-items:center; gap:0.5rem;
}
.logo-dot { width:9px;height:9px;border-radius:50%;background:var(--accent);flex-shrink:0; }
.logo-sub { font-size:0.6rem;color:#5a5148;letter-spacing:0.15em;text-transform:uppercase;margin-top:0.2rem; }

.search-wrap { padding:0.8rem 1rem 0; flex-shrink:0; }
.search-input {
  width:100%;
  background:#2a2520; border:1px solid #3a3530; border-radius:5px;
  padding:0.5rem 0.7rem; color:#f5f2ed;
  font-family:'DM Mono',monospace; font-size:0.75rem; outline:none;
}
.search-input::placeholder { color:#4a4540; }
.search-input:focus { border-color:var(--accent); }

.cat-section { padding:0.8rem 1rem 0.3rem; flex-shrink:0; }
.cat-label { font-size:0.58rem;text-transform:uppercase;letter-spacing:0.18em;color:#4a4540;margin-bottom:0.4rem; }
.cat-list { display:flex;flex-direction:column;gap:0.15rem; }
.cat-item {
  display:flex; align-items:center; justify-content:space-between;
  padding:0.35rem 0.6rem; border-radius:4px; cursor:pointer;
  font-size:0.73rem; color:#9a8f83;
  border:1px solid transparent; transition:all 0.1s;
}
.cat-item:hover { background:#2a2520; color:#f5f2ed; }
.cat-item.active { background:#2a2520; color:#f5f2ed; border-color:#3a3530; }
.cat-item-left { display:flex; align-items:center; gap:0.5rem; }
.cat-dot { width:7px;height:7px;border-radius:50%;flex-shrink:0; }
.cat-count { font-size:0.6rem;background:#2a2520;padding:0.1rem 0.35rem;border-radius:2px;color:#5a5148; }

.resources-list { flex:1; overflow-y:auto; padding:0.6rem 0.8rem; }
.resources-list::-webkit-scrollbar { width:3px; }
.resources-list::-webkit-scrollbar-thumb { background:#3a3530;border-radius:2px; }

.resource-card {
  background:#111; border:1px solid #2a2520; border-radius:7px;
  padding:0.8rem; margin-bottom:0.4rem; cursor:pointer;
  transition:all 0.12s; position:relative;
}
.resource-card:hover { border-color:#4a4540; background:#1a1612; }
.resource-card.active { border-color:var(--accent); background:#1a1612; }
.resource-card.active::before {
  content:''; position:absolute; left:0;top:0;
  width:3px;height:100%;background:var(--accent);
  border-radius:7px 0 0 7px;
}
.rc-title {
  font-family:'Syne',sans-serif; font-size:0.82rem;font-weight:600;
  color:#f5f2ed; margin-bottom:0.3rem; line-height:1.3;
}
.rc-meta { display:flex;align-items:center;gap:0.35rem;flex-wrap:wrap; }
.rc-cat {
  font-size:0.58rem; padding:0.12rem 0.45rem; border-radius:2px;
  font-family:'DM Mono',monospace; letter-spacing:0.04em; text-transform:uppercase;
}
.rc-tag { font-size:0.58rem;color:#4a4540;font-family:'DM Mono',monospace; }

.add-btn-wrap { padding:0.8rem; border-top:1px solid #2a2520; flex-shrink:0; display:flex; flex-direction:column; gap:0.5rem; }
.add-btn {
  width:100%; background:var(--accent); color:white; border:none;
  border-radius:6px; padding:0.65rem;
  font-family:'Syne',sans-serif; font-size:0.82rem; font-weight:700;
  cursor:pointer; transition:all 0.12s;
  display:flex; align-items:center; justify-content:center; gap:0.4rem;
}
.add-btn:hover { background:#a93226; }
.sync-row { display:flex; gap:0.4rem; }
.sync-btn {
  flex:1; background:transparent; border:1px solid #3a3530; border-radius:5px;
  padding:0.45rem 0.3rem; color:#9a8f83;
  font-family:'DM Mono',monospace; font-size:0.68rem;
  cursor:pointer; transition:all 0.12s;
  display:flex; align-items:center; justify-content:center; gap:0.3rem;
}
.sync-btn:hover { background:#2a2520; color:#f5f2ed; border-color:#5a5148; }
.sync-btn.import-btn:hover { border-color:#2d7a47; color:#4ade80; }
.sync-btn.export-btn:hover { border-color:#2c6e8a; color:#60b8d4; }
/* Toast */
.toast {
  position:fixed; bottom:1.5rem; left:50%; transform:translateX(-50%) translateY(20px);
  background:#1a1612; color:#f5f2ed; border:1px solid #3a3530;
  padding:0.6rem 1.2rem; border-radius:6px;
  font-family:'DM Mono',monospace; font-size:0.75rem;
  opacity:0; transition:all 0.25s; z-index:999; white-space:nowrap;
  pointer-events:none;
}
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* MAIN */
.main { flex:1; display:flex; flex-direction:column; overflow:hidden; min-width:0; }

.viewer-toolbar {
  background:var(--surface); border-bottom:1px solid var(--border);
  padding:0.6rem 1.2rem;
  display:none;
  align-items:center; justify-content:space-between; gap:1rem; flex-shrink:0;
}
.viewer-toolbar.visible { display:flex; }
.viewer-title {
  font-family:'Syne',sans-serif; font-weight:700; font-size:0.95rem;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1; min-width:0;
}
.viewer-cat-badge {
  font-size:0.62rem; padding:0.18rem 0.55rem; border-radius:2px;
  font-family:'DM Mono',monospace; text-transform:uppercase; letter-spacing:0.05em; flex-shrink:0;
}
.toolbar-right { display:flex; align-items:center; gap:0.4rem; flex-shrink:0; }
.viewer-tags { display:flex; gap:0.3rem; flex-wrap:wrap; }
.viewer-tag { font-size:0.6rem;color:var(--muted);font-family:'DM Mono',monospace; }
.tb-btn {
  background:var(--surface2); border:1px solid var(--border); border-radius:4px;
  padding:0.3rem 0.6rem; font-family:'DM Mono',monospace; font-size:0.7rem;
  cursor:pointer; color:var(--muted); transition:all 0.12s;
  display:flex; align-items:center; gap:0.3rem; white-space:nowrap;
}
.tb-btn:hover { background:var(--border); color:var(--text); }
.tb-btn.danger:hover { background:#fee2e2; color:var(--accent); border-color:var(--accent); }

.viewer-frame-wrap { flex:1; overflow:hidden; background:#e8e4de; position:relative; }

.empty-state {
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  height:100%; gap:0.8rem; color:var(--muted); padding:2rem; text-align:center;
}
.empty-icon { font-size:3rem; opacity:0.35; }
.empty-title { font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;color:var(--text);opacity:0.4; }
.empty-desc { font-size:0.75rem; max-width:280px; line-height:1.6; opacity:0.7; }

#viewer { width:100%; height:100%; border:none; display:none; }

.no-results { text-align:center; padding:2rem 1rem; color:#4a4540; font-size:0.72rem; }
.no-results-icon { font-size:1.8rem; margin-bottom:0.5rem; opacity:0.3; }

/* MODAL */
.modal-overlay {
  position:fixed; inset:0;
  background:rgba(10,8,6,0.8); backdrop-filter:blur(3px);
  z-index:100; display:none;
  align-items:center; justify-content:center; padding:1rem;
}
.modal-overlay.open { display:flex; }
.modal {
  background:var(--surface); border-radius:10px; border:1px solid var(--border);
  width:100%; max-width:460px;
  animation:slide-up 0.18s ease;
}
@keyframes slide-up { from{transform:translateY(16px);opacity:0} to{transform:translateY(0);opacity:1} }

.modal-header {
  padding:1.2rem 1.3rem 0.9rem; border-bottom:1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between;
}
.modal-title { font-family:'Syne',sans-serif;font-size:1rem;font-weight:800; }
.modal-close { background:none;border:none;font-size:1.1rem;cursor:pointer;color:var(--muted);line-height:1;padding:0.2rem; }
.modal-close:hover { color:var(--text); }
.modal-body { padding:1.1rem 1.3rem; display:flex;flex-direction:column;gap:0.9rem; }

.form-group { display:flex;flex-direction:column;gap:0.35rem; }
.form-label { font-size:0.65rem;text-transform:uppercase;letter-spacing:0.12em;color:var(--muted); }
.form-input {
  background:var(--bg); border:1px solid var(--border); border-radius:5px;
  padding:0.55rem 0.7rem; font-family:'DM Mono',monospace; font-size:0.8rem;
  color:var(--text); outline:none; transition:border-color 0.15s; width:100%;
}
.form-input:focus { border-color:#2c6e8a; }

.drop-zone {
  border:2px dashed var(--border); border-radius:7px; padding:1.2rem;
  text-align:center; cursor:pointer; transition:all 0.15s; background:var(--bg);
  position:relative;
}
.drop-zone:hover,.drop-zone.dragover { border-color:#2c6e8a; background:#f0f6fa; }
.drop-zone input[type=file] {
  position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;
}
.dz-icon { font-size:1.6rem;margin-bottom:0.3rem; }
.dz-text { font-size:0.73rem;color:var(--muted); }
.dz-text strong { color:#2c6e8a; }
.dz-filename { margin-top:0.4rem;font-size:0.72rem;color:#2d7a47;font-weight:500; }
.dz-hint { font-size:0.65rem;color:var(--muted);margin-top:0.25rem;font-style:italic; }

.tags-input-wrap {
  display:flex; flex-wrap:wrap; gap:0.35rem;
  background:var(--bg); border:1px solid var(--border); border-radius:5px;
  padding:0.45rem; min-height:40px; cursor:text; transition:border-color 0.15s;
}
.tags-input-wrap:focus-within { border-color:#2c6e8a; }
.tag-chip {
  background:var(--text); color:var(--bg); font-size:0.65rem;
  padding:0.18rem 0.45rem 0.18rem 0.55rem; border-radius:2px;
  display:flex; align-items:center; gap:0.28rem; font-family:'DM Mono',monospace;
}
.tag-remove { cursor:pointer;opacity:0.6;font-size:0.7rem;line-height:1; }
.tag-remove:hover { opacity:1; }
.tag-text-input {
  border:none; outline:none; background:transparent;
  font-family:'DM Mono',monospace; font-size:0.75rem;
  color:var(--text); min-width:90px; flex:1;
}

.modal-footer {
  padding:0.9rem 1.3rem; border-top:1px solid var(--border);
  display:flex; gap:0.5rem; justify-content:flex-end;
}
.btn-primary {
  background:var(--accent); color:white; border:none; border-radius:5px;
  padding:0.5rem 1.1rem; font-family:'Syne',sans-serif; font-weight:700;
  font-size:0.8rem; cursor:pointer; transition:background 0.12s;
}
.btn-primary:hover { background:#a93226; }
.btn-secondary {
  background:transparent; color:var(--muted); border:1px solid var(--border);
  border-radius:5px; padding:0.5rem 0.9rem; font-family:'DM Mono',monospace;
  font-size:0.75rem; cursor:pointer; transition:all 0.12s;
}
.btn-secondary:hover { background:var(--surface2);color:var(--text); }

.error-msg { font-size:0.68rem;color:var(--accent);margin-top:0.2rem;display:none; }
.error-msg.show { display:block; }
</style>
</head>
<body>
<div class="app">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="logo"><div class="logo-dot"></div>EVIDENCIA</div>
      <div class="logo-sub">Biblioteca de recursos</div>
    </div>
    <div class="search-wrap">
      <input class="search-input" id="searchInput" placeholder="üîç  Buscar‚Ä¶" oninput="renderList()">
    </div>
    <div class="cat-section">
      <div class="cat-label">Categor√≠as</div>
      <div class="cat-list" id="catList"></div>
    </div>
    <div class="resources-list" id="resourcesList"></div>
    <div class="add-btn-wrap">
      <button class="add-btn" onclick="openModal()">Ôºã A√±adir recurso</button>
      <div class="sync-row">
        <button class="sync-btn export-btn" onclick="exportData()">‚¨á Exportar</button>
        <button class="sync-btn import-btn" onclick="document.getElementById('importInput').click()">‚¨Ü Importar</button>
        <input type="file" id="importInput" accept=".json" style="display:none" onchange="importData(event)">
      </div>
    </div>
    <div class="toast" id="toast"></div>
  </div>

  <!-- VIEWER -->
  <div class="main">
    <div class="viewer-toolbar" id="toolbar">
      <div style="display:flex;align-items:center;gap:0.6rem;min-width:0;flex:1">
        <div class="viewer-title" id="vTitle"></div>
        <div class="viewer-cat-badge" id="vCat"></div>
      </div>
      <div class="toolbar-right">
        <div class="viewer-tags" id="vTags"></div>
        <button class="tb-btn" onclick="openEditModal()">‚úèÔ∏è Editar</button>
        <button class="tb-btn danger" onclick="deleteActive()">üóëÔ∏è Eliminar</button>
      </div>
    </div>
    <div class="viewer-frame-wrap">
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">üìö</div>
        <div class="empty-title">Sin recursos a√∫n</div>
        <div class="empty-desc">Pulsa "Ôºã A√±adir recurso" y sube tu archivo .html</div>
      </div>
      <iframe id="viewer" sandbox="allow-scripts allow-same-origin"></iframe>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="overlayClick(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">A√±adir recurso</div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">

      <div class="form-group">
        <div class="form-label">Archivo HTML</div>
        <div class="drop-zone" id="dropZone">
          <input type="file" id="fileInput" accept=".html,.htm" onchange="handleFile(event)">
          <div class="dz-icon">üìÑ</div>
          <div class="dz-text">Arrastra aqu√≠ o <strong>haz clic</strong> para seleccionar</div>
          <div class="dz-filename" id="dzFilename"></div>
          <div class="dz-hint" id="dzHint"></div>
        </div>
        <div class="error-msg" id="fileError">Selecciona un archivo .html</div>
      </div>

      <div class="form-group">
        <div class="form-label">T√≠tulo *</div>
        <input class="form-input" id="iTitle" placeholder="Ej: Limpieza ¬∑ Desinfecci√≥n ¬∑ Esterilizaci√≥n">
        <div class="error-msg" id="titleError">El t√≠tulo es obligatorio</div>
      </div>

      <div class="form-group">
        <div class="form-label">Categor√≠a</div>
        <input class="form-input" id="iCat" list="catSuggestions" placeholder="Ej: Farmacolog√≠a, Urgencias, Anatom√≠a‚Ä¶">
        <datalist id="catSuggestions"></datalist>
      </div>

      <div class="form-group">
        <div class="form-label">Etiquetas ‚Äî pulsa Enter para a√±adir</div>
        <div class="tags-input-wrap" id="tagsWrap" onclick="document.getElementById('tagInput').focus()">
          <input class="tag-text-input" id="tagInput" placeholder="a√±adir etiqueta‚Ä¶" onkeydown="tagKey(event)">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
      <button class="btn-primary" onclick="saveResource()">Guardar</button>
    </div>
  </div>
</div>

<script>
const LS_KEY = 'evidencia_v1';
const CAT_COLORS = ['#c0392b','#2c6e8a','#2d7a47','#7a4f9a','#c0732b','#1a7a6e','#8a2c6e','#6e4a1a'];
const catColorMap = {};

function catColor(cat) {
  if (!cat) return '#7a6f63';
  if (!catColorMap[cat]) catColorMap[cat] = CAT_COLORS[Object.keys(catColorMap).length % CAT_COLORS.length];
  return catColorMap[cat];
}

let resources = [], activeId = null, editingId = null, currentFilter = 'all';
let pendingContent = null, modalTags = [];

function load() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) { resources = JSON.parse(raw); resources.forEach(r => r.category && catColor(r.category)); }
  } catch(e) { resources = []; }
  renderAll();
}

function save() {
  try { localStorage.setItem(LS_KEY, JSON.stringify(resources)); }
  catch(e) { alert('No se pudo guardar. El almacenamiento puede estar lleno.'); }
}

function esc(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function renderAll() { renderCategories(); renderList(); }

function renderCategories() {
  const cats = {};
  resources.forEach(r => { const c = r.category||'Sin categor√≠a'; cats[c]=(cats[c]||0)+1; });
  document.getElementById('catSuggestions').innerHTML = Object.keys(cats).map(c=>`<option value="${esc(c)}">`).join('');

  const list = document.getElementById('catList');
  list.innerHTML = `<div class="cat-item ${currentFilter==='all'?'active':''}" onclick="filterCat('all',this)">
    <span class="cat-item-left"><div class="cat-dot" style="background:#6a6055"></div>Todos</span>
    <span class="cat-count">${resources.length}</span></div>`;

  Object.entries(cats).forEach(([cat, count]) => {
    const col = catColor(cat);
    const d = document.createElement('div');
    d.className = `cat-item ${currentFilter===cat?'active':''}`;
    d.onclick = () => filterCat(cat, d);
    d.innerHTML = `<span class="cat-item-left"><div class="cat-dot" style="background:${col}"></div>${esc(cat)}</span><span class="cat-count">${count}</span>`;
    list.appendChild(d);
  });
}

function renderList() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const filtered = resources.filter(r => {
    const catMatch = currentFilter==='all' || (r.category||'Sin categor√≠a')===currentFilter;
    const qMatch = !q || r.title.toLowerCase().includes(q) || (r.category||'').toLowerCase().includes(q) || (r.tags||[]).some(t=>t.toLowerCase().includes(q));
    return catMatch && qMatch;
  });

  const list = document.getElementById('resourcesList');
  if (!filtered.length) {
    list.innerHTML = `<div class="no-results"><div class="no-results-icon">${resources.length?'üîç':'üì≠'}</div>${resources.length?'Sin resultados':'A√∫n no hay recursos'}</div>`;
    return;
  }
  list.innerHTML = filtered.map(r => {
    const col = catColor(r.category);
    const tags = (r.tags||[]).slice(0,3).map(t=>`<span class="rc-tag">#${esc(t)}</span>`).join('');
    return `<div class="resource-card ${activeId===r.id?'active':''}" onclick="openResource('${r.id}')">
      <div class="rc-title">${esc(r.title)}</div>
      <div class="rc-meta">${r.category?`<span class="rc-cat" style="background:${col}22;color:${col};border:1px solid ${col}44">${esc(r.category)}</span>`:''}${tags}</div>
    </div>`;
  }).join('');
}

function filterCat(cat, el) {
  currentFilter = cat;
  document.querySelectorAll('.cat-item').forEach(i=>i.classList.remove('active'));
  el.classList.add('active');
  renderList();
}

function openResource(id) {
  const r = resources.find(x=>x.id===id);
  if (!r) return;
  activeId = id;
  renderList();

  document.getElementById('emptyState').style.display = 'none';
  const iframe = document.getElementById('viewer');
  iframe.style.display = 'block';
  document.getElementById('toolbar').classList.add('visible');
  document.getElementById('vTitle').textContent = r.title;

  const vCat = document.getElementById('vCat');
  if (r.category) {
    const col = catColor(r.category);
    vCat.textContent = r.category;
    vCat.style.cssText = `background:${col}22;color:${col};border:1px solid ${col}44;display:inline-block`;
  } else { vCat.style.display='none'; }

  document.getElementById('vTags').innerHTML = (r.tags||[]).map(t=>`<span class="viewer-tag">#${esc(t)}</span>`).join('');

  // Use srcdoc to render the full HTML content
  iframe.srcdoc = r.content;
}

function deleteActive() {
  const r = resources.find(x=>x.id===activeId);
  if (!r || !confirm(`¬øEliminar "${r.title}"?`)) return;
  resources = resources.filter(x=>x.id!==activeId);
  activeId = null;
  save(); renderAll();
  const iframe = document.getElementById('viewer');
  iframe.srcdoc = ''; iframe.style.display = 'none';
  document.getElementById('emptyState').style.display = 'flex';
  document.getElementById('toolbar').classList.remove('visible');
}

function openModal() {
  editingId = null; pendingContent = null; modalTags = [];
  document.getElementById('modalTitle').textContent = 'A√±adir recurso';
  document.getElementById('iTitle').value = '';
  document.getElementById('iCat').value = '';
  document.getElementById('dzFilename').textContent = '';
  document.getElementById('dzHint').textContent = '';
  document.getElementById('fileError').classList.remove('show');
  document.getElementById('titleError').classList.remove('show');
  document.getElementById('fileInput').value = '';
  renderModalTags();
  document.getElementById('modalOverlay').classList.add('open');
}

function openEditModal() {
  const r = resources.find(x=>x.id===activeId);
  if (!r) return;
  editingId = activeId; pendingContent = null;
  modalTags = [...(r.tags||[])];
  document.getElementById('modalTitle').textContent = 'Editar recurso';
  document.getElementById('iTitle').value = r.title;
  document.getElementById('iCat').value = r.category||'';
  document.getElementById('dzFilename').textContent = '';
  document.getElementById('dzHint').textContent = 'Opcional: sube un nuevo .html para reemplazar';
  document.getElementById('fileError').classList.remove('show');
  document.getElementById('titleError').classList.remove('show');
  document.getElementById('fileInput').value = '';
  renderModalTags();
  document.getElementById('modalOverlay').classList.add('open');
}

function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }
function overlayClick(e) { if (e.target.id==='modalOverlay') closeModal(); }

function handleFile(e) { const f=e.target.files[0]; if(f) readFile(f); }

function readFile(file) {
  const reader = new FileReader();
  reader.onload = ev => {
    pendingContent = ev.target.result;
    document.getElementById('dzFilename').textContent = '‚úì ' + file.name;
    document.getElementById('fileError').classList.remove('show');
    if (!document.getElementById('iTitle').value)
      document.getElementById('iTitle').value = file.name.replace(/\.html?$/i,'').replace(/[-_]/g,' ');
  };
  reader.readAsText(file, 'UTF-8');
}

const dz = document.getElementById('dropZone');
dz.addEventListener('dragover', e=>{e.preventDefault();dz.classList.add('dragover');});
dz.addEventListener('dragleave', ()=>dz.classList.remove('dragover'));
dz.addEventListener('drop', e=>{
  e.preventDefault(); dz.classList.remove('dragover');
  const f = e.dataTransfer.files[0];
  if (f && /\.html?$/i.test(f.name)) readFile(f);
});

function tagKey(e) {
  if (e.key==='Enter'||e.key===',') {
    e.preventDefault();
    const val = e.target.value.trim().replace(/,/g,'');
    if (val && !modalTags.includes(val)) { modalTags.push(val); renderModalTags(); }
    e.target.value = '';
  }
}

function renderModalTags() {
  const wrap = document.getElementById('tagsWrap');
  const inp = document.getElementById('tagInput');
  wrap.innerHTML = '';
  modalTags.forEach((t,i)=>{
    const c = document.createElement('div');
    c.className = 'tag-chip';
    c.innerHTML = `${esc(t)}<span class="tag-remove" onclick="removeTag(${i})">‚úï</span>`;
    wrap.appendChild(c);
  });
  wrap.appendChild(inp);
}

function removeTag(i) { modalTags.splice(i,1); renderModalTags(); }

function saveResource() {
  let ok = true;
  const title = document.getElementById('iTitle').value.trim();
  const category = document.getElementById('iCat').value.trim() || null;

  if (!title) { document.getElementById('titleError').classList.add('show'); ok=false; }
  else document.getElementById('titleError').classList.remove('show');

  if (!editingId && !pendingContent) { document.getElementById('fileError').classList.add('show'); ok=false; }
  else document.getElementById('fileError').classList.remove('show');

  if (!ok) return;
  if (category) catColor(category);

  if (editingId) {
    const r = resources.find(x=>x.id===editingId);
    r.title=title; r.category=category; r.tags=[...modalTags];
    if (pendingContent) r.content=pendingContent;
  } else {
    resources.unshift({ id:'r_'+Date.now(), title, category, tags:[...modalTags], content:pendingContent, addedAt:new Date().toISOString() });
  }

  save(); renderAll(); closeModal();
  openResource(editingId || resources[0].id);
}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function exportData() {
  if (!resources.length) { showToast('‚ö†Ô∏è No hay recursos que exportar'); return; }
  const blob = new Blob([JSON.stringify({ version:1, exportedAt: new Date().toISOString(), resources }, null, 2)], { type:'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'evidencia_backup_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  showToast('‚úì Exportado ‚Äî ' + resources.length + ' recursos');
}

// ‚îÄ‚îÄ IMPORT ‚îÄ‚îÄ
function importData(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      const imported = Array.isArray(data) ? data : (data.resources || []);
      if (!imported.length) throw new Error();
      const existing = new Set(resources.map(r => r.id));
      let added = 0;
      imported.forEach(r => {
        if (r.id && r.title && r.content && !existing.has(r.id)) {
          resources.unshift(r);
          if (r.category) catColor(r.category);
          added++;
        }
      });
      save(); renderAll();
      showToast(added > 0 ? '‚úì ' + added + ' recursos importados' : '‚ö†Ô∏è Sin recursos nuevos (ya exist√≠an)');
    } catch(err) {
      showToast('‚úó Archivo no v√°lido');
    }
    e.target.value = '';
  };
  reader.readAsText(file, 'UTF-8');
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

load();
</script>
</body>
</html>
